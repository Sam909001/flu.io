<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="$FLUFFI is a Solana Layer 2 meme token with presale and staking features. Join the community and earn rewards.">
  <meta name="keywords" content="Fluffi, $FLUFFI, crypto, presale, staking, Solana, meme token">
  <meta name="author" content="FLUFFI Team">
  <title>$FLUFFI Presale & Staking</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="icon" href="fluffi.jpg" type="image/jpeg">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">

  <style>
    body {
      background: linear-gradient(to bottom, #fff0f5, #fff9e6);
      color: #1a1a1a;
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .timer { font-family: monospace; }
    .section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; }
    .wallet-modal {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5);
        display: flex; align-items: center; justify-content: center; z-index: 1000;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .wallet-modal.active { opacity: 1; pointer-events: all; }
    .wallet-modal-content {
        background: white; border-radius: 16px; width: 90%; max-width: 400px;
        padding: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .dark .wallet-modal-content { background: #1f2937; color: #f0f0f0; }
    .wallet-option {
        display: flex; align-items: center; gap: 12px; padding: 12px;
        border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: background 0.2s;
    }
    .wallet-option:hover { background: #f5f5f5; }
    .dark .wallet-option:hover { background: #374151; }
    .wallet-option img { width: 32px; height: 32px; border-radius: 8px; }
    .wallet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .wallet-close { cursor: pointer; font-size: 24px; }
    .qr-modal {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6);
        display: flex; align-items: center; justify-content: center; z-index: 1001;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .qr-modal.active { opacity: 1; pointer-events: all; }
    .qr-modal-content { background: white; padding: 25px; border-radius: 16px; text-align: center; }
    .dark .qr-modal-content { background: #1f2937; }
    /* General styles, dark mode, animations etc. */
    .dark { background: #111827 !important; color: #f0f0f0 !important; }
    .dark .bg-white { background-color: #1f2937 !important; color: #f0f0f0 !important; }
    .dark .text-gray-600 { color: #d1d5db !important; }
    .dark .text-gray-500 { color: #9ca3af !important; }
    .dark .bg-gray-100 { background-color: #374151 !important; }
    .logo-float { animation: fluffi-float 12s ease-in-out infinite; }
    @keyframes fluffi-float {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-8px) scale(1.02); }
    }
    .notification {
        position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px;
        color: white; font-weight: 500; z-index: 2000;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        opacity: 0; transform: translateX(100%); animation: slideIn 0.5s forwards;
    }
    @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
    .notification.error { background-color: #ef4444; }
    .notification.success { background-color: #22c55e; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.10.5/dist/umd/index.min.js"></script>

</head>
<body class="text-gray-800 dark:text-white">
  <header class="bg-green-600 shadow sticky top-0 z-10 px-4 py-3">
    <div class="max-w-screen-xl mx-auto flex flex-col md:flex-row items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="logo-container logo-float">
          <img src="fluffi.jpg" alt="FLUFFI Logo" class="w-10 h-10 rounded-full">
        </div>
        <h1 class="text-3xl md:text-4xl font-bold text-white">$FLUFFI</h1>
      </div>
      <nav class="flex flex-wrap items-center gap-4 mt-2 md:mt-0 text-sm font-semibold">
        <a href="#presale" class="text-white hover:underline">Presale</a>
        <a href="#staking" class="text-white hover:underline">Staking</a>
        <a href="#faq" class="text-white hover:underline">FAQ</a>
        <a href="Fluffi_Whitepaper_Detailed.pdf" target="_blank" class="text-white hover:underline">Whitepaper</a>
        <button onclick="toggleDarkMode()" class="ml-2 bg-gray-300 dark:bg-gray-700 px-2 rounded text-black dark:text-white" aria-label="Toggle dark mode">
            <span id="darkModeIcon">🌙</span>
        </button>
        <button id="walletButton" class="bg-green-700 hover:bg-green-800 text-white py-2 px-4 rounded-lg font-bold">Connect Wallet</button>
      </nav>
    </div>
  </header>

  <main class="p-6 mx-auto w-full max-w-6xl">
    <div id="countdown-container" class="text-center my-10 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg max-w-xl mx-auto">
      <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">🚀 PRESALE ENDS IN:</h3>
      <div id="presale-timer" class="text-2xl font-mono text-red-600 dark:text-red-300">
        <span id="presale-days">00</span>d
        <span id="presale-hours">00</span>h
        <span id="presale-minutes">00</span>m
        <span id="presale-seconds">00</span>s
      </div>
      <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
        <h4 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300">Current Stage Progress</h4>
        <div class="w-full bg-gray-300 dark:bg-gray-600 h-4 rounded-full overflow-hidden mb-2">
          <div id="stageProgressBar" class="h-full bg-green-500 transition-all duration-1000 ease-in-out" style="width: 0%"></div>
        </div>
        <div class="flex justify-between text-sm font-mono text-gray-700 dark:text-gray-300">
          <span>Stage: <span id="current-stage">1</span>/15</span>
          <span>Ends in: <span id="stage-time-left">00d 00h 00m 00s</span></span>
        </div>
      </div>
    </div>

    <section id="presale" class="mb-6 p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
      <h2 class="section-title">🚀 Presale is Live!</h2>
      <div class="flex gap-2 mb-4">
        <input type="number" placeholder="Amount in BNB" id="amountInput" class="w-full p-3 border rounded-lg text-black dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" aria-label="Amount to purchase">
        <select id="currencySelect" class="p-3 border rounded-lg text-black dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" aria-label="Currency selection">
          <option value="BNB">BNB</option>
          <option value="USD" disabled>USD (soon)</option>
        </select>
      </div>
      <input type="text" placeholder="Referral wallet (optional)" id="refInput" class="w-full p-3 border rounded-lg mb-4 text-black dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" aria-label="Referral wallet address">
      <button onclick="buyFluffi()" id="buyButton" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-semibold text-lg transition-colors">🚀 Buy Now</button>
    </section>

    <section id="staking" class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg mb-6">
      <h2 class="section-title">📈 Stake Your $FLUFFI</h2>
      <p class="mb-4 text-yellow-600 font-semibold">APY: <strong>90%</strong> | Ends at Listing Date</p>
      <input type="number" placeholder="Amount to stake" id="stakeInput" class="w-full p-3 border rounded-lg mb-4 text-black dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-yellow-500" aria-label="Amount to stake">
      <button onclick="stakeFluffi()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-3 px-6 rounded-lg font-semibold">Stake Now</button>
    </section>
    <section id="tokenomics" class="px-6 py-10 bg-white dark:bg-gray-900 rounded-xl shadow-xl mb-12">
        <h2 class="text-3xl font-extrabold text-center text-green-700 dark:text-green-400 mb-8 uppercase tracking-wide">📊 Tokenomics</h2>
        <div class="grid md:grid-cols-2 gap-10 items-center">
          <div>
            <ul class="space-y-4 text-lg text-gray-900 dark:text-white">
              <li><span class="font-semibold text-green-700 dark:text-green-400">Total Supply:</span> <span class="ml-2">10,000,000,000 FLUFFI</span></li>
              <li><span class="font-semibold text-green-700 dark:text-green-400">Presale:</span> <span class="ml-2">40%</span></li>
            </ul>
          </div>
          <div class="flex justify-center"><canvas id="tokenChart" width="280" height="280"></canvas></div>
        </div>
    </section>
  </main>

  <div id="walletModal" class="wallet-modal">
    <div class="wallet-modal-content" onclick="event.stopPropagation()">
      <div class="wallet-header">
        <h3 class="text-xl font-bold">Connect a Wallet</h3>
        <span class="wallet-close" onclick="closeWalletModal()">&times;</span>
      </div>
      <div class="wallet-option" onclick="connectWallet('metamask')">
        <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask">
        <span>MetaMask</span>
      </div>
      <div class="wallet-option" onclick="connectWallet('trustwallet')">
        <img src="https://trustwallet.com/assets/images/media/assets/TWT.png" alt="Trust Wallet">
        <span>Trust Wallet</span>
      </div>
      <div class="wallet-option" onclick="connectWallet('walletconnect')">
        <img src="https://altcoinsbox.com/wp-content/uploads/2023/04/wallet-connect-logo.png" alt="WalletConnect">
        <span>WalletConnect</span>
      </div>
    </div>
  </div>

  <div id="qrModal" class="qr-modal">
    <div class="qr-modal-content" onclick="event.stopPropagation()">
        <h3 class="text-lg font-bold mb-2 dark:text-white">Scan with your wallet</h3>
        <div id="qrcode-container"></div>
        <button onclick="closeQrModal()" class="mt-4 text-sm text-gray-500 hover:text-black dark:hover:text-white">Cancel</button>
    </div>
  </div>


  <script>
    // ===== CONFIGURATION =====
    const FLUFFI_CONTRACT_ADDRESS = "0x60A94bc12d0d4F782Fd597e5E1222247CFb7E297"; // Replace with your actual contract address
    const FLUFFI_CONTRACT_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"Contribution","type":"event"},{"inputs":[{"internalType":"address","name":"referrer","type":"address"}],"name":"contribute","outputs":[],"stateMutability":"payable","type":"function"}]; // Simplified ABI for presale
    const WALLETCONNECT_PROJECT_ID = 'b74a733c47def7b6672eb9ad072c4e8a'; // Replace with your own WalletConnect Project ID

    // ===== GLOBAL VARIABLES =====
    let ethersProvider = null;
    let userWalletAddress = null;
    let wcProvider = null;
    let tokenChart = null;

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize UI components
        initializeDarkMode();
        initTokenChart();
        initializeCountdown();
        checkReferral();

        // Initialize WalletConnect provider
        initializeWalletConnect().catch(console.error);
    });

    function initializeDarkMode() {
        if (localStorage.getItem('darkMode') === 'true' || (!('darkMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            document.getElementById('darkModeIcon').textContent = '☀️';
        }
    }

    // ===== WALLET FUNCTIONS =====
    async function initializeWalletConnect() {
        try {
            wcProvider = await WalletConnectEthereum.EthereumProvider.init({
                projectId: WALLETCONNECT_PROJECT_ID,
                chains: [56], // BSC Mainnet
                showQrModal: false,
                metadata: {
                    name: "$FLUFFI Presale",
                    description: "Connect to the $FLUFFI presale",
                    url: window.location.host,
                    icons: [window.location.origin + '/fluffi.jpg']
                }
            });

            wcProvider.on("display_uri", (uri) => {
                openQrModal(uri);
            });
            wcProvider.on("connect", () => {
                closeQrModal();
                handleConnection(wcProvider);
            });
            wcProvider.on("disconnect", () => {
                disconnectWallet();
            });
        } catch (e) {
            console.error("Could not initialize WalletConnect.", e);
            showNotification("Could not initialize WalletConnect. Please refresh.", 'error');
        }
    }

    function openWalletModal() {
        document.getElementById('walletModal').classList.add('active');
    }

    function closeWalletModal() {
        document.getElementById('walletModal').classList.remove('active');
    }

    function openQrModal(uri) {
        const container = document.getElementById('qrcode-container');
        container.innerHTML = '';
        new QRCode(container, {
            text: uri,
            width: 220,
            height: 220,
            colorDark: document.documentElement.classList.contains('dark') ? "#FFFFFF" : "#000000",
            colorLight: "#00000000"
        });
        document.getElementById('qrModal').classList.add('active');
    }

    function closeQrModal() {
        document.getElementById('qrModal').classList.remove('active');
    }

    async function connectWallet(walletType) {
        closeWalletModal();
        let provider;
        try {
            if (walletType === 'metamask' || walletType === 'trustwallet') {
                if (typeof window.ethereum === 'undefined') {
                    showNotification('Please install a wallet extension like MetaMask!', 'error');
                    return window.open('https://metamask.io/download/', '_blank');
                }
                provider = window.ethereum;
                await provider.request({ method: 'eth_requestAccounts' });
            } else if (walletType === 'walletconnect') {
                if (!wcProvider) {
                    return showNotification('WalletConnect is not ready. Please refresh.', 'error');
                }
                await wcProvider.connect();
                provider = wcProvider;
            }
            if (provider) {
                handleConnection(provider);
            }
        } catch (error) {
            console.error("Failed to connect wallet:", error);
            showNotification('Failed to connect wallet. User rejected request.', 'error');
        }
    }

    async function handleConnection(provider) {
        ethersProvider = new ethers.providers.Web3Provider(provider);
        const signer = ethersProvider.getSigner();
        userWalletAddress = await signer.getAddress();
        updateWalletUI(true);
        showNotification('Wallet connected successfully!', 'success');
    }

    function disconnectWallet() {
        if (wcProvider?.connected) {
            wcProvider.disconnect();
        }
        ethersProvider = null;
        userWalletAddress = null;
        updateWalletUI(false);
        showNotification('Wallet disconnected.');
    }

    function updateWalletUI(isConnected) {
        const walletButton = document.getElementById('walletButton');
        if (isConnected && userWalletAddress) {
            const shortAddress = `${userWalletAddress.slice(0, 5)}...${userWalletAddress.slice(-4)}`;
            walletButton.textContent = shortAddress;
            walletButton.onclick = disconnectWallet;
        } else {
            walletButton.textContent = 'Connect Wallet';
            walletButton.onclick = openWalletModal;
        }
    }

    // ===== DAPP CORE FUNCTIONS =====
    async function buyFluffi() {
        if (!userWalletAddress || !ethersProvider) {
            return showNotification('Please connect your wallet first.', 'error');
        }
        const amountStr = document.getElementById('amountInput').value;
        const ref = document.getElementById('refInput').value.trim();
        const buyBtn = document.getElementById('buyButton');

        if (!amountStr || isNaN(amountStr) || Number(amountStr) <= 0) {
            return showNotification('Please enter a valid BNB amount.', 'error');
        }

        let referralAddress = ethers.constants.AddressZero;
        if (ref && ethers.utils.isAddress(ref)) {
            referralAddress = ref;
        }

        buyBtn.disabled = true;
        buyBtn.innerHTML = '⏳ Processing...';

        try {
            const signer = ethersProvider.getSigner();
            const contract = new ethers.Contract(FLUFFI_CONTRACT_ADDRESS, FLUFFI_CONTRACT_ABI, signer);
            const value = ethers.utils.parseEther(amountStr);

            const tx = await contract.contribute(referralAddress, { value });
            await tx.wait();
            showNotification('Purchase successful!', 'success');

        } catch (error) {
            console.error("Purchase failed:", error);
            const message = error.reason || "Transaction was rejected or failed.";
            showNotification(`Error: ${message}`, 'error');
        } finally {
            buyBtn.disabled = false;
            buyBtn.innerHTML = '🚀 Buy Now';
        }
    }

    function stakeFluffi() {
        showNotification("Staking feature will be available after the presale ends.");
    }

    // ===== UI & UTILITY FUNCTIONS =====
    function toggleDarkMode() {
        document.documentElement.classList.toggle('dark');
        const isDark = document.documentElement.classList.contains('dark');
        localStorage.setItem('darkMode', isDark);
        document.getElementById('darkModeIcon').textContent = isDark ? '☀️' : '🌙';
        if (tokenChart) {
            tokenChart.destroy();
            initTokenChart();
        }
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.remove();
        }, 4000);
    }

    function initTokenChart() {
      const ctx = document.getElementById('tokenChart');
      if (!ctx) return;
      const isDark = document.documentElement.classList.contains('dark');
      tokenChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
              labels: ['Presale (40%)', 'Liquidity (30%)', 'Staking (20%)', 'Marketing (5%)', 'Team (5%)'],
              datasets: [{
                  data: [40, 30, 20, 5, 5],
                  backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6'],
                  borderWidth: 3,
                  borderColor: isDark ? '#1f2937' : '#FFFFFF'
              }]
          },
          options: {
              responsive: true, maintainAspectRatio: false, cutout: '65%',
              plugins: { legend: { display: false } }
          }
      });
    }

    function initializeCountdown() {
        // Your existing timer logic is good, no changes needed here.
        // It should be called from DOMContentLoaded.
    }
    const getPresaleStartTime = () => parseInt(localStorage.getItem('presaleStartTime') || Date.now());

    function updateTimers() {
        const now = Date.now();
        const startTime = getPresaleStartTime();
        const stageDuration = 48 * 3600 * 1000;
        const totalDuration = 15 * stageDuration;
        const endTime = startTime + totalDuration;
        const totalTimeLeft = endTime - now;
        if (totalTimeLeft < 0) { /* handle end */ return; }
        // Update total timer
        Object.entries(formatTime(totalTimeLeft)).forEach(([key, value]) => {
            const el = document.getElementById(`presale-${key}`);
            if (el) el.textContent = value;
        });
    }
    setInterval(updateTimers, 1000);
    
    function formatTime(ms) {
        const d = Math.floor(ms / 86400000);
        const h = Math.floor((ms % 86400000) / 3600000);
        const m = Math.floor((ms % 3600000) / 60000);
        const s = Math.floor((ms % 60000) / 1000);
        return {days:d.toString().padStart(2,'0'), hours:h.toString().padStart(2,'0'), minutes:m.toString().padStart(2,'0'), seconds:s.toString().padStart(2,'0')};
    }
    
    function checkReferral() {
        const ref = new URLSearchParams(window.location.search).get('ref');
        if (ref && ethers.utils.isAddress(ref)) {
            document.getElementById('refInput').value = ref;
        }
    }
  </script>
</body>
</html>
